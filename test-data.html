<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据管理器测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            color: #a0c4ff;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .data-section {
            background: rgba(30, 60, 114, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .data-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }
        .data-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00ff88;
        }
        .data-label {
            font-size: 0.9em;
            color: #a0c4ff;
            margin-bottom: 5px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success { background: rgba(40, 167, 69, 0.2); }
        .status.error { background: rgba(220, 53, 69, 0.2); }
        .status.info { background: rgba(0, 123, 255, 0.2); }
        button {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: rgba(0, 212, 255, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>数据管理器测试页面</h1>
        
        <div class="status" id="status">正在初始化数据管理器...</div>
        
        <div class="controls">
            <button onclick="startUpdates()">开始实时更新</button>
            <button onclick="stopUpdates()">停止实时更新</button>
            <button onclick="resetData()">重置数据</button>
            <button onclick="showAllData()">显示所有数据</button>
        </div>

        <div class="data-section">
            <h2>环境数据</h2>
            <div class="data-grid" id="environmentData">
                <!-- 环境数据将在这里显示 -->
            </div>
        </div>

        <div class="data-section">
            <h2>设备数据</h2>
            <div class="data-grid" id="equipmentData">
                <!-- 设备数据将在这里显示 -->
            </div>
        </div>

        <div class="data-section">
            <h2>生产数据</h2>
            <div class="data-grid" id="productionData">
                <!-- 生产数据将在这里显示 -->
            </div>
        </div>

        <div class="data-section">
            <h2>警报数据</h2>
            <div id="alertData">
                <!-- 警报数据将在这里显示 -->
            </div>
        </div>
    </div>

    <script src="js/data-manager.js"></script>
    <script>
        let dataManager;
        let updateInterval;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.dataManager) {
                    dataManager = window.dataManager;
                    updateStatus('数据管理器初始化成功', 'success');
                    
                    // 订阅数据更新
                    dataManager.subscribe('environmentData', updateEnvironmentDisplay);
                    dataManager.subscribe('equipmentData', updateEquipmentDisplay);
                    dataManager.subscribe('productionData', updateProductionDisplay);
                    dataManager.subscribe('alertData', updateAlertDisplay);
                    
                    // 显示初始数据
                    showAllData();
                } else {
                    updateStatus('数据管理器初始化失败', 'error');
                }
            }, 1000);
        });

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function startUpdates() {
            if (dataManager) {
                dataManager.startRealTimeUpdates(2000);
                updateStatus('实时更新已启动', 'success');
            }
        }

        function stopUpdates() {
            if (dataManager) {
                dataManager.stopRealTimeUpdates();
                updateStatus('实时更新已停止', 'info');
            }
        }

        function resetData() {
            if (dataManager) {
                dataManager.resetData();
                updateStatus('数据已重置', 'info');
                setTimeout(showAllData, 1000);
            }
        }

        function showAllData() {
            if (dataManager) {
                const data = dataManager.getAllData();
                if (data) {
                    updateEnvironmentDisplay(data.environmentData);
                    updateEquipmentDisplay(data.equipmentData);
                    updateProductionDisplay(data.productionData);
                    updateAlertDisplay(data.alertData);
                }
            }
        }

        function updateEnvironmentDisplay(data) {
            const container = document.getElementById('environmentData');
            if (!data) return;
            
            container.innerHTML = '';
            Object.keys(data).forEach(key => {
                const item = data[key];
                const div = document.createElement('div');
                div.className = 'data-item';
                div.innerHTML = `
                    <div class="data-label">${key}</div>
                    <div class="data-value">${item.current} ${item.unit}</div>
                `;
                container.appendChild(div);
            });
        }

        function updateEquipmentDisplay(data) {
            const container = document.getElementById('equipmentData');
            if (!data) return;
            
            container.innerHTML = '';
            Object.keys(data).forEach(key => {
                const item = data[key];
                const div = document.createElement('div');
                div.className = 'data-item';
                div.innerHTML = `
                    <div class="data-label">${key}</div>
                    <div class="data-value">效率: ${item.efficiency}%</div>
                    <div class="data-label">状态: ${item.status}</div>
                `;
                container.appendChild(div);
            });
        }

        function updateProductionDisplay(data) {
            const container = document.getElementById('productionData');
            if (!data) return;
            
            container.innerHTML = '';
            if (data.dailyProgress) {
                const div = document.createElement('div');
                div.className = 'data-item';
                const latest = data.dailyProgress.grassSquares.slice(-1)[0] || 0;
                div.innerHTML = `
                    <div class="data-label">今日草方格</div>
                    <div class="data-value">${latest}</div>
                `;
                container.appendChild(div);
            }
        }

        function updateAlertDisplay(data) {
            const container = document.getElementById('alertData');
            if (!data) return;
            
            container.innerHTML = `
                <p>严重警报: ${data.critical?.length || 0}</p>
                <p>一般警告: ${data.warnings?.length || 0}</p>
                <p>信息提示: ${data.info?.length || 0}</p>
            `;
        }
    </script>
</body>
</html>
